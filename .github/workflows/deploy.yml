name: Deploy Maven Project to Dev Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: åˆ¤å®šæ˜¯å¦éœ€è¦éƒ¨ç½²
        id: version_check
        run: |
          current_version=$(grep -A1 '<artifactId>glancy-backend</artifactId>' pom.xml | grep '<version>' | sed -E 's/.*<version>(.*)<\/version>.*/\1/')
          previous_version=$(git show HEAD~1:pom.xml | grep -A1 '<artifactId>glancy-backend</artifactId>' | grep '<version>' | sed -E 's/.*<version>(.*)<\/version>.*/\1/' || echo '')
          curr_minor=$(echo "$current_version" | cut -d. -f2)
          prev_minor=$(echo "$previous_version" | cut -d. -f2)
          if [ "$curr_minor" != "$prev_minor" ]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi
          echo "version=$current_version" >> $GITHUB_OUTPUT

      - name: Setup SSH
        if: steps.version_check.outputs.deploy == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.REMOTE_HOST }} >> ~/.ssh/known_hosts
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      - name: éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨
        if: steps.version_check.outputs.deploy == 'true'
        run: |
          ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF2'
            set -e
            cd /home/ecs-user/glancy-backend

            echo "ğŸ“¦ ä¿®æ”¹è¿œç¨‹ä»“åº“ä¸º SSH"
            git remote set-url origin git@github.com:TaylorChyi/glancy-backend.git  # âœ… ç¡®ä¿ç”¨ SSH

            echo "ğŸ“¦ æ‹‰å–æœ€æ–°ä»£ç "
            git pull origin main

            echo "ğŸ”§ æ‰“åŒ…é¡¹ç›®"
            ./mvnw clean package -DskipTests

            echo "ğŸ›‘ ç»ˆæ­¢æ—§æœåŠ¡ï¼ˆå¦‚æœ‰ï¼‰"
            PID=$(ps -ef | grep 'glancy-backend.*.jar' | grep -v grep | awk '{print $2}')
            if [ -n "$PID" ]; then
              kill -9 $PID
              echo "âœ… å·²æ€æ‰æ—§è¿›ç¨‹ PID=$PID"
            else
              echo "â„¹ï¸ æœªæ‰¾åˆ°æ—§è¿›ç¨‹ï¼Œè·³è¿‡ kill"
            fi

            echo "ğŸš€ å¯åŠ¨æ–°æœåŠ¡"
            nohup java -jar target/glancy-backend-${{ steps.version_check.outputs.version }}.jar > backend.log 2>&1 &

            echo "âœ… éƒ¨ç½²å®Œæˆ"
          EOF2
